<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Kanji Guessing Game</title>
</head>

<body>
  <h1>Kanji Guessing Game</h1>

  <!-- Lobby section -->
  <div id="lobby-section">
    <button onclick="createLobby()">Create Lobby</button>
    <input type="text" id="lobbyIdInput" placeholder="Enter Lobby ID">
    <button onclick="joinLobby()">Join Lobby</button>
    <div id="lobbyStatus"></div>
  </div>

  <!-- Game section (hidden until a lobby is created/joined) -->
  <div id="game-section" style="display: none;">
    <div id="kanji"></div>
    <input type="text" id="userInput" placeholder="Enter a word">
    <button onclick="submitWord()">Submit</button>
    <button onclick="getKanji(); clearInput()">New Kanji</button>
    <div id="result"></div>
    <div id="score"></div>
  </div>

  <script>
    // Global variable to hold the current lobby ID
    let lobbyId = "";

    function clearInput() {
      document.getElementById("userInput").value = "";
    }

    // Create a new lobby
    async function createLobby() {
      const response = await fetch('/lobby/create', {method: 'POST'});
      const data = await response.json();
      if (data.lobby_id) {
        lobbyId = data.lobby_id;
        document.getElementById("lobbyStatus").innerText = "Lobby created: " + lobbyId;
        // Hide lobby section and show game section
        document.getElementById("lobby-section").style.display = "none";
        document.getElementById("game-section").style.display = "block";
        getKanji();
      } else {
        document.getElementById("lobbyStatus").innerText = "Error creating lobby";
      }
    }

    // Join an existing lobby using the provided ID
    async function joinLobby() {
      const inputLobbyId = document.getElementById("lobbyIdInput").value.trim();
      if (!inputLobbyId) {
        document.getElementById("lobbyStatus").innerText = "Please enter a lobby ID";
        return;
      }
      const response = await fetch(`/lobby/join/${inputLobbyId}`);
      const data = await response.json();
      if (data.lobby_id) {
        lobbyId = data.lobby_id;
        document.getElementById("lobbyStatus").innerText = "Joined lobby: " + lobbyId;
        // Hide lobby section and show game section
        document.getElementById("lobby-section").style.display = "none";
        document.getElementById("game-section").style.display = "block";
        getKanji();
      } else {
        document.getElementById("lobbyStatus").innerText = data.error || "Error joining lobby";
      }
    }

    // Fetch a random kanji from the lobby
    async function getKanji() {
      if (!lobbyId) return;
      const response = await fetch(`/kanji/${lobbyId}`);
      const data = await response.json();
      if (data.kanji) {
        document.getElementById("kanji").innerText = `Kanji: ${data.kanji}`;
        document.getElementById("kanji").dataset.kanji = data.kanji;
      } else {
        document.getElementById("kanji").innerText = data.error || "Error fetching kanji";
      }
    }

    // Submit a word guess for the current kanji
    async function submitWord() {
      if (!lobbyId) return;
      const kanji = document.getElementById("kanji").dataset.kanji;
      const word = document.getElementById("userInput").value;
      const response = await fetch(`/check_word/${lobbyId}`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({word, kanji})
      });
      const data = await response.json();
      if (data.message) {
        document.getElementById("result").innerText = data.message;
        document.getElementById("score").innerText = `Score: ${data.score}`;
      } else {
        document.getElementById("result").innerText = data.error || "Error checking word";
      }
    }
  </script>
</body>

</html>
